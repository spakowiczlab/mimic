---
title: "Mimic.tumor.vs.time"
author: "Yangyang Liu"
date: "6/10/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load required packages
library(readxl)
library(tidyverse)

# Load file paths
source("00-paths.R")
```

# 1. Read in data 

```{r import data}
raw.tumor <- read_xlsx(file.path(paths$box, "data", "AOT00041318",
                                 "AOT00041318_size-measurements.xlsx"))

head(raw.tumor)
```

# 2. Clean, format and create variables

```{r formatting}
# Calculate tumor volume and create other variables needed for plotting
meas <- 
  raw.tumor %>%
  mutate(tumor.volume = (`tumor.length.(mm)` * (`tumor.width.(mm)`^2)) / 2) %>%
  # NA tumor volume means it was too small to be measured -- set to 0
  mutate(tumor.volume = dplyr::if_else(is.na(tumor.volume),
                                       true = 0,
                                       false = tumor.volume)) %>%
  # Adjust the microbiome sample name to generalize
  mutate(condition = dplyr::if_else(grepl("v3", microbiome.sample),
                                    true = "pre-DI",
                                    false = "post-DI")) %>%
  # Create a unique mouse ID
  mutate(mouse = paste(tail.number, treatment, condition, sep = ".")) %>%
  # Create 4 treatment groups
  mutate(treatment.group = paste(condition, treatment, sep = ".")) %>%
  mutate(treatment.group = fct_relevel(treatment.group,
                                       c("pre-DI.IgG",
                                         "pre-DI.Anti-PD-1",
                                         "post-DI.IgG",
                                         "post-DI.Anti-PD-1"))) %>%
  group_by(mouse, date) %>%
  mutate(total.tumor.volume = sum(tumor.volume)) %>%
  distinct(date, mouse, treatment.group, total.tumor.volume) %>%
  # Create a factor time variable for making boxplots
  group_by(mouse) %>%
  mutate(time.point = row_number(date)) %>%
  mutate(time.point = as.factor(time.point)) %>%
  dplyr::select(date, mouse, treatment.group, time.point, total.tumor.volume) %>%
  rename("tumor.volume" = "total.tumor.volume")

head(meas)
```

```{r}

# Calculate tumor volume and save in a new column : tumor.size
raw.tumor$tumor.volume <- (raw.tumor$`tumor.length.(mm)`*raw.tumor$`tumor.width.(mm)`*raw.tumor$`tumor.width.(mm)`)/2

# Merge rows for mouse with more than 1 tumors : addition
merge.tumor <- aggregate(tumor.volume ~ date + tail.number + microbiome.sample + treatment, FUN = sum, data=raw.tumor)
merge.tumor <- merge.tumor[order(as.Date(merge.tumor$date, format="%d/%m/%Y")),]

#Calculate mean and standard error per group per date (V3-IgG, V3-anti-PD1, V4-IgG, V4-anti-PD-1) -yet to be done

#set up four separate groups in one column and remove the previous columns
merge.tumor$Groups <- paste(merge.tumor$microbiome.sample, merge.tumor$treatment)
merge.tumor = subset(merge.tumor, select = -c(microbiome.sample, treatment) )


```


# 3. Visualize

```{r linefit}
meas %>%
  ggplot(aes(x = date, y = tumor.volume)) +
  geom_line(aes(color = treatment.group, group = mouse), alpha = 0.1) +
  stat_smooth(aes(color = treatment.group), method = "lm")
  # geom_point(aes(color = treatment.group))
```

```{r boxplots}
meas %>%
  ggplot(aes(time.point, tumor.volume)) +
  geom_boxplot(aes(color = treatment.group)) +
  geom_line(aes(group = mouse, color = treatment.group), alpha = 0.2) +
  theme_bw() +
  ggsave("../figures/AOT00041318_boxplot.png",
         height = 6, width = 8)
```

```{r summarize}
summ.meas <- 
  meas %>%
  group_by(treatment.group, date) %>%
  summarize(mean = mean(tumor.volume),
            sd = sd(tumor.volume), .groups= 'drop') %>%
  mutate(lwr = mean - sd,
         upr = mean + sd) %>%
  # A negative error bar doesn't make sense in this context, set to 0
  mutate(lwr = if_else(lwr < 0, 0, lwr))
```

```{r line plot with points and error bars}
#no error bar version
meas %>%
  ggplot(aes(time.point, tumor.volume)) +
  geom_line(aes(group = mouse, color = treatment.group), alpha = 0.2)+
  geom_point(aes(color=treatment.group))
#error bar version
summ.meas %>%
  ggplot(aes(x = date, y = mean, color = treatment.group)) +
  geom_line()+
  geom_point()+
  geom_errorbar(aes(ymin = lwr, ymax = upr))+
  ggsave("../figures/volume.over.time.png")
# Keep only upper error bars, not so relavant here but will keep as for future reference
meas %>%
  ggplot(aes(time.point, tumor.volume)) +
  geom_line(aes(group = mouse, color = treatment.group), alpha = 0.2)+
  geom_point(aes(color=treatment.group))+
  geom_errorbar(aes(ymin = tumor.volume, ymax = tumor.volume - summ.meas$upr, color = treatment.group), width = 0.1)  
```

```{r graveyard misc, eval=F}
tumor.volume <- read.csv("~/Box/mimic/data/AOT00041318/AOT00041318.tumor.size.calculated.csv")

mean.and.sd <- data_summary(merge.tumor, all_of(tumor.volume="mean", Groups=c("Groups","tail.number")))
head(mean.and.sd)

mean.and.sd <- data_summary(merge.tumor, Groups, tumor.volume="mean")
head(mean.and.sd)

#+++++++++++++++++++++++++
# Function to calculate the mean and the standard deviation
  # for each group
#+++++++++++++++++++++++++
# data : a data frame
# varname : the name of a column containing the variable
  #to be summariezed
# groupnames : vector of column names to be used as
  # grouping variables
data_summary <- function(merge.tumor, tumor.volume, Groups){
  require(plyr)
  summary_func <- function(x, tumor.volume){
    c(mean = mean(x[[tumor.volume]], na.rm=TRUE),
      sd = sd(x[[tumor.volume]], na.rm=TRUE))
  }
  data_sum<-ddply(merge.tumor, Groups, .fun=summary_func,
                  tumor.volume)
  data_sum <- rename(data_sum, c("mean" = tumor.volume))
 return(data_sum)
}

mean.and.sd <- data_summary(merge.tumor, Groups=c("Groups"), tumor.volume="mean")
head(mean.and.sd)

#graph
ggplot(merge.tumor, aes(x=date, y=tumor.volume, group=tail.number, color=Groups)) + 
  geom_errorbar(aes(ymin=tumor.volume-sd, ymax=tumor.volume+sd), width=.1, 
    position=position_dodge(0.05)) +
    geom_line()+
    geom_point()


library(mosaic)
favstats(tumor.volume~treatment.group,data=meas)

#mean and sd
mean.and.sd <- aggregate(merge.tumor$tumor.volume, list(merge.tumor$Groups), mean)
sd <- aggregate(merge.tumor$tumor.volume, list(merge.tumor$Groups), sd)
mean.and.sd$sd <- sd
#Rename mean and sd columns
mean.and.sd <- mean.and.sd %>% 
  rename(
    mean = x, 
    )
#remove not needed columns
mean.and.sd <- mean.and.sd[-1]

#merge summ.meas with meas, set up a new table name, then assign it for the line plot=cannot work, different length
finaldoc <- merge(summ.meas, meas)
#position dosge for ggplot errorbar
position=position_dodge(0.5) 


```{r ggplot per mouse samples}

merge.tumor%>%
  ggplot( aes(x=date, y=tumor.volume, color=Groups)) +
  geom_errorbar(aes(ymin = sd, ymax = sd), width = 0.2)+      
    geom_line()+
    geom_point()
```
    
```

